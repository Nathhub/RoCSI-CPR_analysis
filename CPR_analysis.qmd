# CPR Dataset

## ðŸ“¦ Build the phyloseq object (CPR data)

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(phyloseq)

# ---- load data ----
counts <- read_csv("data/count_table_CPR.csv")
taxo <- read_csv("data/taxonomy_table_CPR.csv")
meta <- read_csv("data/metadata_CPR.csv")

taxtab <- as.matrix(taxo[,-1])
row.names(taxtab) <- taxo[[1]]

# Create a Phyloseq object

ps_cpr <- phyloseq(otu_table(counts, taxa_are_rows = F), 
                   sample_data(meta), 
                   tax_table(taxtab))
saveRDS(ps_cpr, "data/ps_cpr.rds")
cat("ðŸ”¹ ** A summary of the phyloseq object**\n")
print(ps_cpr)
```
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Print sample names, taxonomy ranks, and metadata fields â€” with explanations
cat("ðŸ”¹ **These are the metadata variables:**\n")
print(sample_variables(ps_cpr))
```
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Print sample names, taxonomy ranks, and metadata fields â€” with explanations
cat("ðŸ”¹ **These are the taxonomic levels:**\n")
print(rank_names(ps_cpr))
```
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Print sample names, taxonomy ranks, and metadata fields â€” with explanations
cat("ðŸ”¹ **These are the metadata variables:**\n")
print(sample_variables(ps_cpr))
```

## ðŸ“Š Data visualisation

In this section, we explore the CPR community structure using the
`phyloseq` object (`ps_cpr`) generated above. We start by visualising overall counts
per sample, followed by basic taxonomic composition summaries.

### Counts per sample
```{r, echo=FALSE, message=FALSE, warning=FALSE}
read_depth <- data.frame(
Sample = sample_names(ps_cpr),
Reads = sample_sums(ps_cpr),
check.names = FALSE
)

ggplot(read_depth, aes(x = Sample, y = Reads)) +
geom_col() +
theme_minimal() +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) + # Rotate x-axis labels for better readability
scale_x_discrete(
    labels = function(x) substr(x, 1, 6), # Show only the first 5 characters of each label
    breaks = function(x) x[seq(1, length(x), by = 4)] # Show every 4th label
  ) +
labs(
title = "CPR overall counts per sample",
x = "Sample",
y = "Number of counts"
)
```
::: {.callout-note}
### ðŸ’¬ Discussion â€” Overall counts per sample

We can see an important variability between the total counts of each sample. Sample 19, 20 28 and 34 are particularly low in total counts.
:::

### Alpha diversity

```{r, echo=FALSE, message=FALSE, warning=FALSE}
sample_data(ps_cpr)$Water_masses <- ifelse(sample_data(ps_cpr)$Longitude < -10,
                                       "Open Ocean", "Shelf")

# Make sure Water_masses is a factor (optional, but useful for consistent plotting)
sample_data(ps_cpr)$Water_masses <- factor(sample_data(ps_cpr)$Water_masses, 
                                       levels = c("Open Ocean", "Shelf"))

plot_richness(ps_cpr, x="Longitude", measures=c("Shannon", "Simpson"), color = "Water_masses", 
               title = "CPR Alpha Diversity")

# plot_richness(ps_cpr, x="Number", measures=c("Shannon", "Observed"), color = "Water_masses", 
#               title = "CPR Alpha Diversity")
# # 
# # plot_richness(ps_cpr, x="cpr", measures=c("Shannon", "Observed"))
# 
# plot_richness(ps_cpr, x = "Longitude", measures = c("Shannon", "Observed"), color = "Water_masses", 
#               title = "CPR Alpha Diversity")
```
::: {.callout-note}
### ðŸ’¬ Discussion â€” Alpha diversity patterns

Similarly to the diversity plots of the COI and 18S datasets, the CPR diversity plots show differences in alpha diversity between water masses: Open Ocean stations harbor richer and more even metazoan communities, whereas Shelf stations contain fewer taxa and exhibit stronger dominance patterns.

Maybe I should replace counts that are <1 (representing presence only) by 1 so I can plot the "observed diversity"which uses total counts. 

**IMPORTANT**: Simpson diversity is better than Shannon for eDNA metabarcoding data because eDNA data inflates the number of rare taxa. Shannon is very sensitive to rare taxa â†’ it will artificially increase diversity.Simpson is robust to this problem, because rare taxa contribute almost nothing to the index. --> change the previous plot to use Simpson!
:::

### Ordination

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ord <- ordinate(ps_cpr, method = "PCoA", distance = "bray")

# Create the ordination plot with ellipses
plot_ordination(ps_cpr, ord, color = "Water_masses") +
  geom_point(size = 3) +
  ggtitle("Ordination â€“ CPR") +
  stat_ellipse(aes(group = Water_masses), type = "norm", linetype = "dashed", size = 1) +
  scale_color_manual(values = c("Open Ocean" = "#377EB8", "Shelf" = "#FF6666")) +
  theme_minimal()
```
::: {.callout-note}
### ðŸ’¬ Discussion â€” Ordination

Similarly to the diversity plots of the COI and 18S datasets, the CPR ordination shows the open ocean samples being more tightly clustered together than the shelf but it shows a less clear separation between the samples of the two water masses. There are less taxa and samples!
:::

### Phylum composition

```{r, echo=FALSE, message=FALSE, warning=FALSE}
my_colors <- c("#FF6666", "#8DD3C7", "#377EB8", "#4DAF4A",  
               "#984EA3", "#A6D854", "#FFFF33", "#FF7F00", "#F781BF", "#999999",                  "#66C2A5", "#FC8D62", "#8DA0CB", "#E78AC3", "#FFD92F", 
               "#E5C494", "#B3B3B3", "#A65628","#FFFFB3", "#BEBADA", 
               "#FB8072", "#80B1D3", "#FDB462")

classGlommed = tax_glom(ps_cpr, "Phylum")

# transform to proportions
ps_cpr_rel <- transform_sample_counts(classGlommed, function(x) x / sum(x))
# Ensure 'Longitude' is a factor
ps_cpr_rel@sam_data$Longitude <- as.factor(ps_cpr_rel@sam_data$Longitude)

plot_bar(ps_cpr_rel, fill = "Phylum", x = "Longitude") + 
  scale_fill_manual(values = my_colors) + theme_classic() +
  geom_bar(stat = "identity", width = 0.8) +
  scale_y_continuous(labels = scales::percent) +
  labs(y = "Relative abundance (%)", x = "Longitude") +
  ggtitle("Phyla â€“ CPR")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + # Rotate x-axis labels for better readability
  scale_x_discrete(
    labels = function(x) substr(x, 1, 5), # Show only the first 5 characters of each label
    breaks = function(x) x[seq(1, length(x), by = 4)] # Show every 4th label
  )
```

::: {.callout-note}
### ðŸ’¬ Discussion â€” CPR Community Structure

The community is overwhelmingly dominated by **Ochrophyta** (primarily diatoms) and **Dinoflagellata**, which together account for the majority of relative abundance across most of the transect. **Haptophyta** (Coccolithophores) also contribute substantially in several sections, consistent with their known importance in North Atlantic phytoplankton communities.

There is a clear longitudinal gradient, with shifts in the relative dominance of **Ochrophyta** vs **Dinoflagellata** along the transect.

Let's note that abundance of **NAs**! Below we can see that NAs are Plastic, fungi and/or land plant hair.
:::

```{r,,echo=FALSE, message=FALSE, warning=FALSE}
taxo[taxo$Phylum=="N/A",]
```

### Top 10 genera 

```{r,echo=FALSE, message=FALSE, warning=FALSE}
### --------------- Using the microbiome package ----------------
#BiocManager::install("microbiome")
library(microbiome)

# Collapse to genus level
ps_genus <- tax_glom(ps_cpr, taxrank = "Genus")

# Transform to relative abundance
ps_rel <- transform(ps_genus, "compositional")

# Get top 10 genera by mean relative abundance
top10 <- top_taxa(ps_rel, n = 10)  # this returns taxa_names, not Genus strings

# Melt *full* ps_rel, not pruned
df <- psmelt(ps_rel)
df$Longitude <- as.factor(df$Longitude)

# Create a new genus column where everything not in top10 becomes "Other"
df <- df %>%
  mutate(
    Genus_plot = as.character(Genus),
    Genus_plot = if_else(OTU %in% top10, Genus_plot, "Other")
  ) %>%
  group_by(Sample, Longitude, Genus_plot) %>%
  summarise(Abundance = sum(Abundance), .groups = "drop")

# Optional: put "Other" at the end of the legend
df$Genus_plot <- factor(
  df$Genus_plot,
  levels = c(setdiff(sort(unique(df$Genus_plot)), "Other"), "Other")
)

# Pick a clear neutral colour for "Other"
other_color <- "#C0C0C0"

# Fit your colours + "Other" at the end
plot_colors <- c(my_colors[1:10], other_color)

# Plot
ggplot(df, aes(x = Longitude, y = Abundance, fill = Genus_plot)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = plot_colors) + 
  labs(
    title = "Top 10 Genera + Other",
    x = "Longitude",
    y = "Relative Abundance"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(
    labels = function(x) substr(x, 1, 5),
    breaks  = function(x) x[seq(1, length(x), by = 4)]
  )

```
::: {.callout-note}
### ðŸ’¬ Discussion â€” Dominant genera

This plot highlights a community dominated by a small number of well-known North Atlantic phytoplankton genera.

**Ceratum** (dinoflagellates) is a dominant genus across much of the transect, particularly toward the western/ocean-influenced stations.

classical phytoplankton groups (diatoms, dinoflagellates, coccolithophores)
:::

### Copepod genera only

```{r,echo=FALSE, message=FALSE, warning=FALSE}

my_colors <- c(
  "#FF6666", "#8DD3C7", "#377EB8", "#4DAF4A",
  "#984EA3", "#A6D854", "#FFFF33", "#FF7F00",
  "#F781BF", "#999999", "#66C2A5", "#FC8D62",
  "#8DA0CB", "#E78AC3", "#FFD92F", "#E5C494",
  "#B3B3B3", "#A65628", "#FFFFB3", "#BEBADA",
  "#FB8072", "#80B1D3", "#FDB462",
  "#4EB3D3", "#1B1B1B"
)

ps1 <- subset_taxa(ps_cpr, Order %in% c("Calanoida"))

# Collapse to genus level
ps_genus <- tax_glom(ps1, taxrank = "Genus")

# Transform to relative abundance
ps_rel <- transform(ps_genus, "compositional")

# Melt *full* ps_rel, not pruned
df <- psmelt(ps_rel)
df$Longitude <- as.factor(df$Longitude)

# Plot
ggplot(df, aes(x = Longitude, y = Abundance, fill = Genus)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = my_colors) + 
  labs(
    title = "CPR - Copepods Genera",
    x = "Longitude",
    y = "Relative Abundance"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(
    labels = function(x) substr(x, 1, 5),
    breaks  = function(x) x[seq(1, length(x), by = 4)]
  )

```
::: {.callout-note}
### ðŸ’¬ Discussion â€” Dominant arthropods genera


:::

### Top 10 genera (Phytoplankton only)

```{r,echo=FALSE, message=FALSE, warning=FALSE}

my_colors <- c(
  "#FF6666", "#8DD3C7", "#377EB8", "#4DAF4A",
  "#984EA3", "#A6D854", "#FFFF33", "#FF7F00",
  "#F781BF", "#999999", "#66C2A5", "#FC8D62",
  "#8DA0CB", "#E78AC3", "#FFD92F", "#E5C494",
  "#B3B3B3", "#A65628", "#FFFFB3", "#BEBADA",
  "#FB8072", "#80B1D3", "#FDB462",
  "#4EB3D3", "#1B1B1B"
)

phyto_groups <- c(
  "Ochrophyta",
  "Dinoflagellata",
  "Haptophyta",
  "Cyanobacteria",
  "Cercozoa",
  "Ciliophora",
  "Foraminifera",
  "Radiolaria"
)

# 1) keep phyto phyla
ps1 <- subset_taxa(ps_cpr, Phylum %in% phyto_groups)

# 2) collapse to genus
ps_fam <- tax_glom(ps1, taxrank = "Family")

# 3) relative abundance
ps_rel <- transform_sample_counts(ps_fam, function(x) x / sum(x))

# 4) find top 10 taxa (taxa_names) by mean rel. abundance
top10_taxa <- names(sort(taxa_sums(ps_rel) / nsamples(ps_rel), decreasing = TRUE))[1:10]
# Alternatively (true mean across samples):
# top10_taxa <- names(sort(rowMeans(as(otu_table(ps_rel), "matrix")), decreasing = TRUE))[1:10]
# (if taxa are rows; see note below)

# 5) Melt FULL table, then recode genus into Top10 vs Other
df <- psmelt(ps_rel)

# Ensure Longitude exists and use a binned/ordered factor if you want; for now keep as factor
df$Longitude <- as.factor(df$Longitude)

df <- df %>%
    mutate(
        fam_plot = ifelse(OTU %in% top10_taxa, as.character(Family), "Other")
    ) %>%
    group_by(Longitude, fam_plot) %>%
    summarise(Abundance = sum(Abundance), .groups = "drop")

# 6) Make a colour mapping for the 10 genera + Other
top10_fam <- df %>%
    filter(fam_plot != "Other") %>%
    distinct(fam_plot) %>%
    pull(fam_plot)

# keep deterministic order: match top10_taxa -> genus names
tax_tab <- as.data.frame(tax_table(ps_rel)) %>% rownames_to_column("OTU")
top10_fam_ordered <- tax_tab %>%
    filter(OTU %in% top10_taxa) %>%
    pull(Family)

top10_fam_ordered <- unique(top10_fam_ordered[!is.na(top10_fam_ordered) & top10_fam_ordered != ""])

cols_top10 <- setNames(my_colors[1:length(top10_fam_ordered)], top10_fam_ordered)
fill_cols  <- c(cols_top10, Other = "grey80")

df$fam_plot <- factor(df$fam_plot, levels = c(top10_fam_ordered, "Other"))

# 7) Plot
ggplot(df, aes(x = Longitude, y = Abundance, fill = fam_plot)) +
    geom_bar(stat = "identity", position = "stack") +
    scale_fill_manual(values = fill_cols, drop = FALSE, name = "Family") +
    labs(
        title = "CPR - Phytoplankton Families (Top 10 + Other)",
        x = "Longitude",
        y = "Relative Abundance"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    scale_x_discrete(
        labels = function(x) substr(x, 1, 5),
        breaks  = function(x) x[seq(1, length(x), by = 4)]
    )
```
::: {.callout-note}
### ðŸ’¬ Discussion â€” Dominant phyto Families
the top 10 genera plot was the same plot as top 10 genera for the CPR! I therefore switched to Family rank so now we see what is inside the large "N/A" genus (mainly Coccolithaceae and Dictyochaceae)
:::

