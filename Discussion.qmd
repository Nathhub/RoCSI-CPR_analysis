# Discussion — Comparing CPR and eDNA: Dimensions of Diversity

The **Continuous Plankton Recorder (CPR)** and the **RoCSI eDNA metabarcoding** represent fundamentally different ways of observing plankton communities. Rather than asking whether these approaches agree or disagree, a more informative question is at what ecological and taxonomic scales they converge—and where their comparability breaks down.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(phyloseq)
library(ggVennDiagram)

ps_18s <- readRDS("data/ps_18s.rds")
ps_coi <- readRDS("data/ps_coi.rds")
ps_cpr <- readRDS("data/ps_cpr.rds")

get_phyla <- function(ps) {
  tt <- tax_table(ps)

  # pull the Phylum column (as character), drop NA/blank/"NA"
  ph <- as.character(tt[, "Phylum"])
  ph <- ph[!is.na(ph) & ph != "" & ph != "NA"]

  sort(unique(ph))
}

phyla_sets <- list(
  `18S` = get_phyla(ps_18s),
  `COI` = get_phyla(ps_coi),
  `CPR` = get_phyla(ps_cpr)
)

# quick counts
sapply(phyla_sets, length)

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Venn diagram
ggVennDiagram(phyla_sets, label_alpha = 0) +
  ggplot2::labs(title = "Shared phyla across datasets")

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(tibble)
library(tidyr)
library(knitr)

shared_all <- Reduce(intersect, phyla_sets)
only_18s   <- setdiff(phyla_sets$`18S`, union(phyla_sets$`COI`, phyla_sets$`CPR`))
only_coi   <- setdiff(phyla_sets$`COI`, union(phyla_sets$`18S`, phyla_sets$`CPR`))
only_cpr   <- setdiff(phyla_sets$`CPR`, union(phyla_sets$`18S`, phyla_sets$`COI`))

phyla_out <- tibble(
  Category = c("Shared by all", "Only 18S", "Only COI", "Only CPR"),
  `# Phyla` = c(length(shared_all), length(only_18s), length(only_coi), length(only_cpr)),
  Phyla = c(
    paste(sort(shared_all), collapse = ", "),
    paste(sort(only_18s), collapse = ", "),
    paste(sort(only_coi), collapse = ", "),
    paste(sort(only_cpr), collapse = ", ")
  )
)

knitr::kable(phyla_out, align = c("l", "r", "l"))

```

Let's now merge that 2 eDNA metabarcoding datasets:

```{r, echo=FALSE, message=FALSE, warning=FALSE}

# 1) Make taxa IDs unique across markers
taxa_names(ps_18s) <- paste0("18S__", taxa_names(ps_18s))
taxa_names(ps_coi) <- paste0("COI__", taxa_names(ps_coi))

# 2) Add a marker column in the tax_table
add_marker <- function(ps, marker) {
  tt <- as(tax_table(ps), "matrix")
  tt <- cbind(tt, marker = marker)
  tax_table(ps) <- tax_table(tt)
  ps
}
ps_18s <- add_marker(ps_18s, "18S")
ps_coi <- add_marker(ps_coi, "COI")

# 3) Ensure tax_table columns match (pad missing cols with NA)
cols_all <- union(colnames(tax_table(ps_18s)), colnames(tax_table(ps_coi)))

pad_tax <- function(ps, cols_all) {
  tt <- as(tax_table(ps), "matrix")
  miss <- setdiff(cols_all, colnames(tt))
  if (length(miss) > 0) {
    tt <- cbind(tt, matrix(NA, nrow = nrow(tt), ncol = length(miss),
                          dimnames = list(rownames(tt), miss)))
  }
  tt <- tt[, cols_all, drop = FALSE]
  tax_table(ps) <- tax_table(tt)
  ps
}
ps_18s <- pad_tax(ps_18s, cols_all)
ps_coi <- pad_tax(ps_coi, cols_all)

# 4) Merge (stacks taxa/features)
ps_edna <- merge_phyloseq(ps_18s, ps_coi)

ps_edna
table(tax_table(ps_edna)[, "marker"])
```
### compare presence/absence in eDNA vs CPR

```{r, echo=FALSE, message=FALSE, warning=FALSE}
pa_transform <- function(ps) {
  ps_pa <- ps
  otu_table(ps_pa) <- otu_table((otu_table(ps) > 0) * 1, taxa_are_rows(ps))
  ps_pa
}

ps_edna_pa <- pa_transform(ps_edna)
ps_cpr_pa  <- pa_transform(ps_cpr)

# 2 get taxa present at a given taxonomic rank

get_taxa_at_rank <- function(ps, rank) {
  tt <- as.data.frame(tax_table(ps))
  
  # taxa present at least once
  present_taxa <- taxa_names(ps)[taxa_sums(ps) > 0]
  
  # extract taxonomic labels
  taxa <- tt[present_taxa, rank]
  
  taxa <- taxa[!is.na(taxa) & taxa != ""]
  unique(as.character(taxa))
}

# 3 Compare eDNA vs CPR across taxonomic levels
ranks_to_test <- intersect(rank_names(ps_edna), rank_names(ps_cpr))

comparison <- lapply(ranks_to_test, function(rank) {
  edna_taxa <- get_taxa_at_rank(ps_edna_pa, rank)
  cpr_taxa  <- get_taxa_at_rank(ps_cpr_pa,  rank)

  data.frame(
    rank = rank,
    n_edna = length(edna_taxa),
    n_cpr  = length(cpr_taxa),
    n_shared = length(intersect(edna_taxa, cpr_taxa)),
    stringsAsFactors = FALSE
  )
})

taxa_overlap_summary <- do.call(rbind, comparison)

taxa_overlap_summary$perc_shared_edna <- with(
  taxa_overlap_summary,
  100 * n_shared / n_edna
)

taxa_overlap_summary$perc_shared_cpr <- with(
  taxa_overlap_summary,
  100 * n_shared / n_cpr
)

# optional: round for nicer tables
taxa_overlap_summary$perc_shared_edna <- round(taxa_overlap_summary$perc_shared_edna, 1)
taxa_overlap_summary$perc_shared_cpr  <- round(taxa_overlap_summary$perc_shared_cpr, 1)

knitr::kable(
  taxa_overlap_summary,
  caption = "Taxonomic overlap between eDNA and CPR datasets (presence/absence).",
  digits = 1
) |>
  kableExtra::kable_styling(full_width = FALSE)

```


::: {.callout-note}
eDNA detects far more taxonomic diversity than CPR, but overlap drops rapidly with taxonomic resolution; CPR diversity is largely a subset of eDNA at high ranks, while species-level agreement is essentially zero.
:::

### Quantifying agreement using similarity metrics per rank (Jaccard similarity)

Jaccard similarity was chosen to compare eDNA and CPR datasets because it provides a simple measure of shared taxa using presence–absence information

```{r, echo=FALSE, message=FALSE, warning=FALSE}
taxa_overlap_summary$jaccard <- with(
  taxa_overlap_summary,
  n_shared / (n_edna + n_cpr - n_shared)
)

rank_order <- c("Kingdom","Phylum","Class","Order","Family","Genus","Species")
taxa_overlap_summary$rank <- factor(taxa_overlap_summary$rank, levels = rank_order)

library(ggplot2)

ggplot(
  subset(taxa_overlap_summary, rank != "Species"),
  aes(x = rank, y = jaccard)
) +
  geom_col(width = 0.7) +
  scale_y_continuous(limits = c(0, 1)) +
  labs(
    x = "Taxonomic rank",
    y = "Jaccard similarity (presence/absence)",
    title = "Jaccard similarity between eDNA and CPR across taxonomic ranks",
    subtitle = "Species level excluded"
  ) +
  theme_minimal(base_size = 12)

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
present_taxlabels <- function(ps, rank) {
  tt <- as.data.frame(tax_table(ps))
  present_asvs <- taxa_names(ps)[taxa_sums(ps) > 0]
  labs <- tt[present_asvs, rank]

  labs <- as.character(labs)
  labs <- labs[!is.na(labs) & labs != ""]
  sort(unique(labs))
}

ranks_to_test <- intersect(rank_names(ps_edna_pa), rank_names(ps_cpr_pa))

rank_taxa_table <- do.call(
  rbind,
  lapply(ranks_to_test, function(rank) {

    edna_taxa <- present_taxlabels(ps_edna_pa, rank)
    cpr_taxa  <- present_taxlabels(ps_cpr_pa,  rank)
    shared    <- intersect(edna_taxa, cpr_taxa)

    data.frame(
      rank   = rank,
      eDNA   = if (length(edna_taxa) > 0) paste(edna_taxa, collapse = ", ") else NA,
      CPR    = if (length(cpr_taxa)  > 0) paste(cpr_taxa,  collapse = ", ") else NA,
      Shared = if (length(shared)    > 0) paste(shared,    collapse = ", ") else NA,
      stringsAsFactors = FALSE
    )
  })
)

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(gt)

rank_taxa_table |>
  (\(x) x[seq_len(match("Order", x$rank)), ])() |>
  gt(rowname_col = "rank") |>

  # Labels
  cols_label(
    eDNA   = "eDNA taxa",
    CPR    = "CPR taxa",
    Shared = "Shared taxa"
  ) |>

  # Header
  tab_header(
    title = "Rank-by-rank taxonomic composition (presence/absence)",
    subtitle = "Comparison between eDNA and CPR datasets"
  ) |>

  # Improve text handling
  cols_width(
    eDNA   ~ px(350),
    CPR    ~ px(350),
    Shared ~ px(350)
  ) |>

  # Wrap long comma-separated lists
  tab_style(
    style = cell_text(whitespace = "normal"),
    locations = cells_body(everything())
  ) |>

  # Make rank labels stand out
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_stub()
  ) |>

  # Subtle table aesthetics
  opt_all_caps() |>
  tab_options(
    table.font.size = "small",
    data_row.padding = px(6),
    heading.title.font.size = 16,
    heading.subtitle.font.size = 12
  )

```



### Next

- Presence/absence by region: Does agreement improve in high-biomass / high-diversity regions?
- comparing ecological groups: Zooplankton/phytoplankton only
- Sensitivity analysis: e.g. taxa present in ≥2 samples


**A spectrum of biodiversity resolution**

These methods can be viewed as sampling different dimensions of diversity along a continuum of biological detail:

CPR (morphological counts) primarily captures → large-bodied, abundant, and morphologically distinctive taxa → reflects biomass-dominant and ecologically conspicuous organisms → integrates over time and space due to net sampling and tow length

eDNA metabarcoding (18S, COI) captures → small, fragile, rare, cryptic, or early life stages → reflects presence and relative diversity, not biomass → is sensitive to extracellular DNA, transport, and detection limits

Because these approaches target different components of the community, direct one-to-one taxonomic comparisons are not always meaningful.

![Resolution pyramid - CPR vs RoCSI eDNA](CPR%20vs%20eDNA%20biological%20resolution%20comparison.png){width="80%"}

![Horizontal gradient of ecological resolution](ChatGPT%20Image%20Jan%206,%202026,%2003_15_35%20PM.png)

