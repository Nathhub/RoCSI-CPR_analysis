# COI Dataset

## ðŸ“¦ Build the phyloseq object (COI)

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(phyloseq)

# ---- paths ----
datadir <- "data/COI"

# ---- load DADA2 outputs ----
seqtab.nochim <- readRDS(file.path(datadir, "seqtab_nochim.rds"))
taxa          <- readRDS(file.path(datadir, "taxa.rds"))

# Make sure taxonomy is a proper matrix and has consistent column names
taxa <- as.matrix(taxa)
target_cols <- c(
  "Kingdom","Subkingdom_1","Subkingdom_2","Phylum","Subphylum","Subphylum_1","Superclass",
  "Class","Subclass","Infraclass","Superorder","Order","Suborder_1","Suborder_2","Suborder_3",
  "Family","Subfamily","Genus","Subgenus","Species"
)
colnames(taxa) <- target_cols[seq_len(ncol(taxa))]

# Load metadata
metadat <- readRDS(file.path(datadir, "metadata_COI.rds")) 

# Create a Phyloseq object

rownames(seqtab.nochim) <- sub("_$", "", rownames(seqtab.nochim))

ps_coi <- phyloseq(otu_table(seqtab.nochim, taxa_are_rows = F), 
               sample_data(metadat), 
               tax_table(taxa))

saveRDS(ps_coi, "data/ps_coi.rds")
cat("ðŸ”¹ ** A summary of the phyloseq object**\n")
ps_coi

# storing the ASV sequences and assigning them with a name and then renaming the taxa object
dna <- Biostrings::DNAStringSet(taxa_names(ps_coi))
names(dna) <- taxa_names(ps_coi)
ps_coi <- merge_phyloseq(ps_coi, dna)
taxa_names(ps_coi) <- paste0("ASV", seq(ntaxa(ps_coi)))

```
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Print sample names, taxonomy ranks, and metadata fields â€” with explanations
cat("ðŸ”¹ **These are the metadata variables:**\n")
print(sample_variables(ps_coi))
```

## ðŸ“Š Data visualisation

In this section, we explore the community structure from the RoCSI COI dataset using the
`phyloseq` object (`ps_coi`) generated above. We start by visualising read depth
per sample, followed by basic taxonomic composition summaries.

### Read depth per sample
```{r, echo=FALSE, message=FALSE, warning=FALSE}

library(ggplot2)
library(scales)

read_depth <- data.frame(
Sample = sample_names(ps_coi),
Reads = sample_sums(ps_coi),
check.names = FALSE
)

ggplot(read_depth, aes(x = Sample, y = Reads)) +
  geom_col() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + # Rotate x-axis labels for better readability
  scale_x_discrete(
    labels = function(x) substr(x, 1, 6), # Show only the first 5 characters of each label
    breaks = function(x) x[seq(1, length(x), by = 4)] # Show every 4th label
  ) +
  scale_y_continuous(
    labels = label_number(big.mark = ",") # Full numbers with commas
  ) +
  labs(
  title = "Sequencing depth per sample",
  x = "Sample",
  y = "Number of non-chimeric reads"
  )
```

::: {.callout-note}
Let's note that sample 60-CPR_3_ID_11 has 713,247 reads due to the fact that it had 764,251 raw reads from CGR. This difference is not due to the QC/DADA2 process but to the initial sequencing run.
:::

### Alpha diversity

```{r, echo=FALSE, message=FALSE, warning=FALSE}
sample_data(ps_coi)$Water_masses <- ifelse(sample_data(ps_coi)$lon < -10,
                                       "Open Ocean", "Shelf")

# Make sure Water_masses is a factor (optional, but useful for consistent plotting)
sample_data(ps_coi)$Water_masses <- factor(sample_data(ps_coi)$Water_masses, 
                                       levels = c("Open Ocean", "Shelf"))

plot_richness(ps_coi, x = "lon", measures = c("Observed", "Shannon", "simpson"), color = "Water_masses", 
              title = "RoCSI (COI, MZGdb)") +
  scale_color_manual(
    values = c(
      "Open Ocean" = "#2E86C1",
      "Shelf" = "#C0392B"
    )
  )
```

::: {.callout-note}
### ðŸ’¬ Discussion â€” Alpha Diversity Patterns (COI Marker)

The COI dataset shows clear and consistent differences in alpha diversity between water masses: Open Ocean stations harbor richer and more even metazoan communities, whereas Shelf stations contain fewer taxa and exhibit stronger dominance patterns.
These results reinforce the 18S-based observations, indicating that both protist and metazoan communities display higher within-sample diversity offshore.
:::

### Ordination

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ord <- ordinate(ps_coi, method = "PCoA", distance = "bray")

# Create the ordination plot with ellipses
plot_ordination(ps_coi, ord, color = "Water_masses") +
  geom_point(size = 3) +
  ggtitle("Ordination â€“ RoCSI (COI, MZGdb)") +
  stat_ellipse(aes(group = Water_masses), type = "norm", linetype = "dashed", size = 1) +
  scale_color_manual(values = c("Open Ocean" = "#2E86C1","Shelf" = "#C0392B")) +
  theme_minimal()
```
::: {.callout-note}
### ðŸ’¬ Discussion â€” COI Ordination (Beta Diversity)

The COI ordination reveals clear habitat structuring: Shelf communities are highly variable and distinct from the more uniform offshore assemblages.
This pattern is consistent with the COI alpha diversity trendsâ€”Shelf waters show lower within-sample diversity but higher among-sample heterogeneity, while Open Ocean waters show the reverse.

Compared to the 18S ordination, the COI separation between shelf and open-ocean samples is substantially stronger. This likely reflects the inherently greater spatial patchiness of metazoan communities on the Shelf, driven by environmental heterogeneity, including benthicâ€“pelagic coupling, tidal mixing, coastal inputs, and the patchy distribution of zooplankton.

**NOTE**: the 2 Shelf samples that are in the Open Ocean cluster are:
                 Axis.1      Axis.2 Water_masses      lat       lon
30-CPR_2_ID_1 0.1390008 -0.00861632        Shelf 48.33428 -9.665179
73-CPR_4_ID_3 0.1999515 -0.07714278        Shelf 48.52567 -9.307684

As expected they are at the transition between the Shelf and the Open Ocean.
:::

#### coloured by transect
```{r, echo=FALSE, message=FALSE, warning=FALSE}
sample_data(ps_coi)$cpr <- factor(sample_data(ps_coi)$cpr)

plot_ordination(ps_coi, ord, color = "cpr") +
  geom_point(size = 3) +
  stat_ellipse(aes(group = cpr),
               type = "norm",
               linetype = "dashed",
               size = 1) +
  scale_color_manual(values = c("#1B9E77", "#D95F02", "#7570B3", "#E7298A")) +
  ggtitle("Ordination â€“ RoCSI (COI, MZGdb)") +
  theme_minimal()
```

### Phylum composition

```{r, echo=FALSE, message=FALSE, warning=FALSE}
my_colors <- c("#FF6666", "#8DD3C7", "#377EB8", "#4DAF4A",  
               "#984EA3", "#A6D854", "#FFFF33", "#FF7F00", "#F781BF", "#999999", "#66C2A5", 
               "#FC8D62", "#8DA0CB", "#E78AC3", "#FFD92F", 
               "#E5C494", "#B3B3B3", "#A65628","#FFFFB3", "#BEBADA", 
               "#FB8072", "#80B1D3", "#FDB462")

classGlommed = tax_glom(ps_coi, "Phylum")

# transform to proportions
ps_coi_rel <- transform_sample_counts(classGlommed, function(x) x / sum(x))
# Ensure 'lon' is a factor
ps_coi_rel@sam_data$lon <- as.factor(ps_coi_rel@sam_data$lon)

plot_bar(ps_coi_rel, fill = "Phylum", x = "lon") + 
  scale_fill_manual(values = my_colors) + theme_classic() +
  geom_bar(stat = "identity", width = 0.8) +
  scale_y_continuous(labels = scales::percent) +
  labs(y = "Relative abundance (%)", x = "Longitude") +
  ggtitle("Zooplankton Phyla â€“ RoCSI (COI, MZGdb)")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + # Rotate x-axis labels for better readability
  scale_x_discrete(
    labels = function(x) substr(x, 1, 5), # Show only the first 5 characters of each label
    breaks = function(x) x[seq(1, length(x), by = 4)] # Show every 4th label
  )
```

::: {.callout-note}
### ðŸ’¬ Discussion â€” COI Phylum Composition

The COI phylumâ€level composition shows that **Arthropoda, Mollusca**, and **Cnidaria** dominate overall. A distinct shelfâ€“offshore gradient is visible. The low longitude samples contain more **Chordata** and **Annelida**.

The peak of Mollusca abundance in the open ocean might be due to **pelagic gastropods** (pteropods). There seems to be more **Cnidarians** (jellyfish) in the open ocean.
:::

### Top 10 genera 

```{r,echo=FALSE, message=FALSE, warning=FALSE}
### --------------- Using the microbiome package ----------------
#BiocManager::install("microbiome")
library(microbiome)

# Collapse to genus level
ps_genus <- tax_glom(ps_coi, taxrank = "Genus")

# Transform to relative abundance
ps_rel <- transform(ps_genus, "compositional")

# Get top 10 genera by mean relative abundance
top10 <- top_taxa(ps_rel, n = 10)  # this returns taxa_names, not Genus strings

# Melt *full* ps_rel, not pruned
df <- psmelt(ps_rel)
df$lon <- as.factor(df$lon)

# Create a new genus column where everything not in top10 becomes "Other"
df <- df %>%
  mutate(
    Genus_plot = as.character(Genus),
    Genus_plot = if_else(OTU %in% top10, Genus_plot, "Other")
  ) %>%
  group_by(Sample, lon, Genus_plot) %>%
  summarise(Abundance = sum(Abundance), .groups = "drop")

# Optional: put "Other" at the end of the legend
df$Genus_plot <- factor(
  df$Genus_plot,
  levels = c(setdiff(sort(unique(df$Genus_plot)), "Other"), "Other")
)

# Pick a clear neutral colour for "Other"
other_color <- "#C0C0C0"

# Fit your colours + "Other" at the end
plot_colors <- c(my_colors[1:10], other_color)

# Plot
ggplot(df, aes(x = lon, y = Abundance, fill = Genus_plot)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = plot_colors) + 
  labs(
    title = "COI - Top 10 Genera + Other",
    x = "Longitude",
    y = "Relative Abundance",
    fill = "Genus",
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(
    labels = function(x) substr(x, 1, 5),
    breaks  = function(x) x[seq(1, length(x), by = 4)]
  )

```
::: {.callout-note}
### ðŸ’¬ Discussion â€” Interpreting the COI Community at the Genus Level

At the genus level, the COI data show a **copepod-dominated zooplankton community** along the whole transect:

- **Oithona** (light green) and **Paracalanus** (orange) are abundant across almost all stations, forming a widespread â€œbackgroundâ€ community present in both Shelf and Open Ocean waters.

- **Clausocalanus** (red) is abundant in Open Ocean waters.

- Other copepods and zooplankton, such as **Oncaea**, **Nannocalanus**, **Ditricohorycaeus**, **Mikroconchoecia**, plus gelatinous taxa like **Clytia** and **Pelagia**, appear more patchily, with localised peaks at particular longitudes.

- The rise of the **â€œOtherâ€ category** toward the eastern end suggests additional, rarer genera becoming important near the more coastal / English Channelâ€“influenced stations.
:::

### Top 10 copepod genera 

```{r,echo=FALSE, message=FALSE, warning=FALSE}

ps1 <- subset_taxa(ps_coi, Class %in% c("Copepoda"))

# Collapse to genus level
ps_genus <- tax_glom(ps1, taxrank = "Genus")

# Transform to relative abundance
ps_rel <- transform(ps_genus, "compositional")

# Get top 10 genera by mean relative abundance
top10 <- top_taxa(ps_rel, n = 10)  # this returns taxa_names, not Genus strings

# Melt *full* ps_rel, not pruned
df <- psmelt(ps_rel)
df$lon <- as.factor(df$lon)

# Create a new genus column where everything not in top10 becomes "Other"
df <- df %>%
  mutate(
    Genus_plot = as.character(Genus),
    Genus_plot = if_else(OTU %in% top10, Genus_plot, "Other")
  ) %>%
  group_by(Sample, lon, Genus_plot) %>%
  summarise(Abundance = sum(Abundance), .groups = "drop")

# Optional: put "Other" at the end of the legend
df$Genus_plot <- factor(
  df$Genus_plot,
  levels = c(setdiff(sort(unique(df$Genus_plot)), "Other"), "Other")
)

# Pick a clear neutral colour for "Other"
other_color <- "#C0C0C0"

# Fit your colours + "Other" at the end
plot_colors <- c(my_colors[1:10], other_color)

# Plot
ggplot(df, aes(x = lon, y = Abundance, fill = Genus_plot)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = plot_colors) + 
  labs(
    title = "COI - Top 10 copepod Genera + Other",
    x = "Longitude",
    y = "Relative Abundance",
    fill = "Genus",
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(
    labels = function(x) substr(x, 1, 5),
    breaks  = function(x) x[seq(1, length(x), by = 4)]
  )

```
::: {.callout-note}
### ðŸ’¬ Discussion â€”


:::

